name: Deploy to ECS

on:
  workflow_run:
    workflows: ["Build and Push to ECR"]
    types: [completed]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
  ECS_TASK_DEFINITION: ${{ secrets.ECS_TASK_DEFINITION }}
  ECS_CONTAINER_NAME: ${{ secrets.ECS_CONTAINER_NAME }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create new task definition revision with new image
        id: taskdef
        run: |
          IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:${{ github.event.workflow_run.head_sha }}"

          aws ecs describe-task-definition \
            --task-definition "$ECS_TASK_DEFINITION" \
            --query taskDefinition > taskdef.json

          # Remove fields AWS won't accept on register
          cat taskdef.json | jq '
            del(
              .taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy
            )
            | (.containerDefinitions[] | select(.name=="'"$ECS_CONTAINER_NAME"'") | .image) = "'"$IMAGE"'"
          ' > taskdef-fixed.json

          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef-fixed.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          echo "new_td_arn=$NEW_TD_ARN" >> $GITHUB_OUTPUT
          echo "Deployed image: $IMAGE"
          echo "New task definition: $NEW_TD_ARN"

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "${{ steps.taskdef.outputs.new_td_arn }}" \
            --force-new-deployment

      - name: Wait for service stability
        run: |
          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"
